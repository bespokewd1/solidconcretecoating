---
import { getCollection } from "astro:content";
import { Image } from "astro-lqip/components";
import type { ImageMetadata } from "astro";
import type { CollectionEntry } from "astro:content";
import type { HTMLAttributes } from "astro/types";

type props = HTMLAttributes<"section">;
// Types
type GalleryEntry = CollectionEntry<"gallery">;

type FlattenedImage = {
  image: ImageMetadata;
  imageAlt: string;
  title?: string;
};

// Fetch all gallery posts and sort by date (newest first)
const galleryPosts = await getCollection("gallery");

galleryPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Flatten all images from all posts with fallback alt/title logic
const allImages: FlattenedImage[] = [];

galleryPosts.forEach((post) => {
  if (!post.data.images || !Array.isArray(post.data.images)) {
    console.error("No images array found in post:", post.id);
    return;
  }

  post.data.images.forEach((img, index) => {
    const imageNumber = index + 1;
    allImages.push({
      image: img.image,
      imageAlt: img.imageAlt || `${post.data.defaultAlt} ${imageNumber}`,
      title:
        img.title ||
        (post.data.defaultTitle
          ? `${post.data.defaultTitle} ${imageNumber}`
          : undefined),
    });
  });
});

// Distribute images across 3 columns for masonry layout
const columns: FlattenedImage[][] = [[], [], []];
allImages.forEach((img, index) => {
  columns[index % 3].push(img);
});

const { class: className, ...props } = Astro.props;
---

<!-- ============================================ --><!--                   Gallery                    --><!-- ============================================ -->
<section
  id="portfolio"
  class:list={["overflow-hidden px-4 py-16", className]}
  {...props}
>
  <div class="mx-auto max-w-[82.625rem]">
    <span
      class="block text-center text-sm font-medium tracking-wide text-accent uppercase italic"
    >
      Our Portfolio
    </span>

    <h2
      class="mx-auto mb-10 max-w-[38.8125rem] text-center text-heading font-extrabold tracking-wide text-fore-dark uppercase"
    >
      Epoxy Flooring Portfolio in Edmonton: Garage, Basement, Commercial &
      Industrial Finishes
    </h2>
    <!-- <h2
      class="mx-auto mb-10 max-w-[38.8125rem] text-center text-3xl font-bold md:text-4xl"
    >
      Epoxy Flooring Portfolio in Edmonton: Garage, Basement, Commercial &
      Industrial Finishes
    </h2> -->

    {
      allImages.length === 0 && (
        <div class="my-8 text-center text-fore-dark/80">
          <p>No gallery images found. Add some images in the CMS!</p>
        </div>
      )
    }

    {
      allImages.length > 0 && (
        <div class="gallery-scroll-container mb-16 max-h-[1250px] overflow-y-auto xl:max-h-[2500px]">
          <div class="columns-1 sm:columns-2 lg:columns-3">
            {allImages.map((item: FlattenedImage, imgIndex: number) => (
              <div
                class="group relative mb-4 break-inside-avoid overflow-hidden"
                data-stagger-b
                data-distance-y="200"
                data-delay-s={imgIndex * 0.11}
                data-once="true"
              >
                <Image
                  src={item.image}
                  alt={item.imageAlt}
                  class="h-auto w-full object-cover"
                  lqip="base64"
                  lqipSize={10}
                />
              </div>
            ))}
          </div>
        </div>
      )
    }

    <!-- <a href="/projects" class="cs-button-solid">View all projects</a> -->
  </div>
</section>

<style>
  /* Custom scrollbar styling (optional) */
  .gallery-scroll-container {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
  }

  .gallery-scroll-container::-webkit-scrollbar {
    width: 8px;
  }

  .gallery-scroll-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .gallery-scroll-container::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  .gallery-scroll-container::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.5);
  }

  /* Dark mode scrollbar */
  body.dark-mode .gallery-scroll-container {
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  body.dark-mode .gallery-scroll-container::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
  }

  body.dark-mode .gallery-scroll-container::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.5);
  }
</style>
