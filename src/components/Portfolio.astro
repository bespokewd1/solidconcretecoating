---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

// Fetch all gallery images and sort by date (newest first)
const galleryImages = await getCollection("gallery");
galleryImages.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Distribute images across 3 columns for masonry layout
const columns = [[], [], []];
galleryImages.forEach((img, index) => {
  columns[index % 3].push(img);
});
---

<!-- ============================================ --><!--                   Gallery                    --><!-- ============================================ -->
<section id="portfolio">
  <div class="cs-container">
    <span class="cs-topper">Our Portfolio</span>
    <h2 class="cs-title">Et orci volutpat, back up generator installations</h2>
    <div class="cs-image-group">
      {
        columns.map((column, colIndex) => (
          <div class={`cs-row cs-row-${colIndex + 1}`}>
            {column.map((item, imgIndex) => (
              <div class={`cs-picture cs-picture${imgIndex + 1}`}>
                <Image
                  src={item.data.image}
                  alt={item.data.imageAlt}
                  width={420}
                  height={560}
                  loading="lazy"
                  decoding="async"
                  class="cs-img"
                />
                {item.data.title && (
                  <span class="cs-caption">{item.data.title}</span>
                )}
              </div>
            ))}
          </div>
        ))
      }
    </div>
    <a href="/projects" class="cs-button-solid">View all projects</a>
  </div>
</section>

<style lang="less">
  /*-- -------------------------- -->
  <---          portfolio           -->
  <--- -------------------------- -*/

  /* Mobile - 360px */
  @media only screen and (min-width: 0em) {
    #portfolio {
      text-align: center;
      padding: var(--sectionPadding);
      position: relative;
      overflow: hidden;

      .cs-container {
        width: 100%;
        max-width: calc(1322 / 16 * 1em);
        margin: auto;
      }

      .cs-topper {
        text-align: center;
        margin-bottom: calc(16 / 16 * 1rem);
      }

      .cs-title {
        text-align: center;
        max-width: calc(621 / 16 * 1rem);
        margin-bottom: calc(40 / 16 * 1rem);
      }

      .cs-image-group {
        font-size: min(1.1vw, 1em);
        width: 100%;
        max-width: calc(1322 / 16 * 1em);
        margin: 0 auto calc(60 / 16 * 1rem);
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: calc(30 / 16 * 1em);
      }

      .cs-row {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        gap: calc(30 / 16 * 1em);
        flex: 1;
      }

      .cs-picture {
        display: block;
        position: relative;
        width: 100%;
        overflow: hidden;
        border-radius: 8px;

        .cs-img {
          width: 100%;
          height: auto;
          object-fit: cover;
          display: block;
        }

        .cs-caption {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 0.5rem;
          font-size: 0.9rem;
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        &:hover .cs-caption {
          opacity: 1;
        }
      }
    }
  }

  /* Dark mode */
  @media only screen and (min-width: 0em) {
    body.dark-mode {
      #portfolio {
        .cs-title {
          color: var(--bodyTextColorWhite);
        }
      }
    }
  }
</style>
