---
import { Icon } from "astro-icon/components";
import { Image } from "astro-lqip/components";
import BeforeAfterSlider from "@components/BeforeAfterSlider.astro";
import CTALink from "@components/CTALink.astro";

import type { HTMLAttributes } from "astro/types";

type Props = HTMLAttributes<"section">;

import resFloor from "@assets/images/services/b4-after-res.webp";
import poly from "@assets/images/services/flake-1.png";
import resFloor2 from "@assets/images/services/res-floor-1.png";
import resFloor3 from "@assets/images/services/res-floor-2.png";
import resFloor4 from "@assets/images/services/res-floor-3.png";
import resFloor5 from "@assets/images/services/res-floor-4.png";
import resFloor6 from "@assets/images/services/res-floor-5.png";
import cn from "@utils/cn";

type ServiceCategory = {
  icon: string;
  text: string;
  description: string;
  beforeImage: ImageMetadata;
  afterImage: ImageMetadata;
};

const serviceCategories: ServiceCategory[] = [
  {
    icon: "tabler:car",
    text: "Garage Floors",
    description:
      "Durable, stain-resistant coatings built for hot tires, salt, and daily wear.",
    beforeImage: resFloor,
    afterImage: resFloor2,
  },
  {
    icon: "tabler:stairs-down",
    text: "Basements",
    description:
      "Moisture-tough flooring that brightens your basement and stays easy to clean.",
    beforeImage: resFloor3,
    afterImage: resFloor4,
  },
  {
    icon: "tabler:plant-2",
    text: "Outdoor Patios",
    description:
      "UV-stable, slip-resistant finishes designed to handle weather and foot traffic.",
    beforeImage: resFloor4,
    afterImage: resFloor5,
  },
  {
    icon: "tabler:road",
    text: "Driveways",
    description:
      "Strong, curb-appeal coatings that help protect concrete from stains and erosion.",
    beforeImage: resFloor2,
    afterImage: resFloor3,
  },
];

const { class: className, ...props } = Astro.props;
---

<section
  id="residential-coatings"
  class:list={["scroll-mt-32 px-4 py-section-padding sm:px-8", className]}
  {...props}
  data-content-active="1"
>
  <div class="mx-auto max-w-7xl">
    <div class="grid items-center gap-12 lg:grid-cols-2 lg:gap-16">
      <!-- Content -->
      <div
        data-reveal
        data-direction="left"
        data-distance-x="50"
        data-once="true"
      >
        <div class="mb-4 flex items-center gap-3">
          <div
            class="flex size-12 items-center justify-center rounded-full bg-accent/10"
          >
            <Icon name="tabler:home-2" class="size-6 text-accent" />
          </div>
          <span
            class="font-mont text-sm font-bold tracking-widest text-accent uppercase"
          >
            Residential
          </span>
        </div>

        <h2
          class="mb-6 font-mont text-3xl font-bold text-fore-dark sm:text-4xl"
        >
          Residential Concrete Coatings
        </h2>

        <p class="mb-8 font-mont text-lg leading-relaxed text-fore-dark/80">
          Upgrade your home's flooring with our residential concrete coatings.
          Perfect for garages, basements, patios, and driveways. Our coatings
          are scratch-resistant, easy to maintain, and customizable with
          multiple flake colors.
        </p>

        <!-- Popular Uses -->
        <div class="mb-8">
          <h3
            class="mb-4 font-mont text-sm font-bold tracking-widest text-fore-dark/50 uppercase"
          >
            Popular Uses
          </h3>
          <div class="grid grid-cols-2 gap-3">
            {
              serviceCategories.map((item, idx) => (
                <button
                  class:list={cn([
                    "group flex items-center gap-3 rounded-sm bg-fore-light p-3 shadow-sm",
                    idx === 0 ? "bg-accent/30" : "",
                  ])}
                  data-tab={idx + 1}
                >
                  <Icon name={item.icon} class="size-5 text-accent" />
                  <span class="font-mont text-sm font-medium text-fore-dark/60 group-hover:text-fore-dark">
                    {item.text}
                  </span>
                </button>
              ))
            }
          </div>
        </div>

        <!-- Benefits -->
        <div class="mb-8">
          <h3
            class="mb-4 font-mont text-sm font-bold tracking-widest text-neutral-500 uppercase"
          >
            Benefits
          </h3>
          <ul class="space-y-3">
            {
              [
                "Scratch & Stain Resistant",
                "Easy to Maintain",
                "Adds Value to Your Home",
                "Non-Slip Surface Options",
              ].map((benefit) => (
                <li class="flex items-center gap-3 font-mont text-neutral-700">
                  <Icon
                    name="tabler:circle-check-filled"
                    class="size-5 shrink-0 text-primary"
                  />
                  {benefit}
                </li>
              ))
            }
          </ul>
        </div>

        <CTALink variant="primary" showIcon={true} />
      </div>

      <!-- Image Grid -->
      <div
        id="res-content-grid"
        class="grid grid-cols-2 grid-rows-[auto_auto] gap-4"
        data-reveal
        data-direction="right"
        data-distance-x="50"
        data-delay-s="0.15"
        data-once="true"
      >
        <div class="col-span-full grid overflow-hidden pr-10 pb-10">
          {
            serviceCategories.map((item, idx) => (
              <div
                class="group relative rounded-sm shadow-lg [grid-area:1/1]"
                data-content={idx + 1}
                style="display: none;"
              >
                <BeforeAfterSlider
                  beforeImage={item.beforeImage}
                  beforeAlt={`${item.text} before coating`}
                  afterAlt={`${item.text} after coating`}
                  afterImage={item.afterImage}
                />

                <div class="absolute -right-4 -bottom-4 z-20 grid place-content-center items-center overflow-hidden sm:-right-8 sm:-bottom-8">
                  <div class="rounded-sm bg-primary p-6 transition-all [grid-area:1/1] group-hover:translate-x-[150%] group-hover:opacity-0 group-hover:transition-opacity">
                    <Icon
                      name={item.icon}
                      class="mb-2 size-8 text-fore-light/90"
                    />
                    <p class="font-mont text-sm font-bold text-fore-light">
                      {item.text}
                    </p>
                  </div>
                  <div class="size-0 translate-x-full place-content-center overflow-hidden rounded-sm bg-primary p-0 transition-transform duration-200 ease-in [grid-area:1/1] group-hover:size-full group-hover:translate-x-0 group-hover:p-6">
                    <p class="font-mont text-sm font-bold text-fore-light">
                      {item.description}
                    </p>
                  </div>
                </div>
              </div>
            ))
          }

          <!-- <button
                  class="flex items-center gap-3 rounded-sm bg-fore-light p-3 shadow-sm hover:bg-accent/20"
                  data-tab={idx + 1}
                >
                  <Icon name={item.icon} class="size-5 text-accent" />
                  <span class="font-mont text-sm font-medium text-fore-dark/60">
                    {item.text}
                  </span>
                </button> -->
          <!-- <div class="h-48 w-full sm:h-64"> -->
        </div>
        <div class="col-span-full overflow-hidden">
          <div class="h-48 w-full sm:h-min">
            <Image
              src={poly}
              alt="Epoxy coating layers diagram"
              class="size-full object-cover"
              loading="lazy"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from "gsap";

  function switchTab() {
    const parent = document.getElementById(
      "residential-coatings",
    ) as HTMLElement;
    if (!parent) return;

    const buttons = parent.querySelectorAll(
      "[data-tab]",
    ) as NodeListOf<HTMLButtonElement>;
    const contents = parent.querySelectorAll(
      "[data-content]",
    ) as NodeListOf<HTMLElement>;
    const contentContainer = parent.querySelector(
      "#res-content-grid",
    ) as HTMLElement;

    const AUTOPLAY_INTERVAL = 3000;
    const TOTAL_TABS = buttons.length;

    let autoplayTimer: ReturnType<typeof setTimeout> | null = null;
    let isInView = false;
    let isPaused = false;
    let observer: IntersectionObserver | null = null;

    // Initialize first content
    gsap.set(contents[0], { display: "block", x: 0, opacity: 1 });

    function goToTab(tab: string, skipAnimation = false) {
      const activeContent = parent.dataset.contentActive;
      if (tab === activeContent) return;

      parent.dataset.contentActive = tab;

      const currentContent = parent.querySelector(
        `[data-content="${activeContent}"]`,
      ) as HTMLElement;
      const targetContent = parent.querySelector(
        `[data-content="${tab}"]`,
      ) as HTMLElement;

      if (skipAnimation) {
        if (currentContent) gsap.set(currentContent, { display: "none" });
        if (targetContent)
          gsap.set(targetContent, { display: "block", x: 0, opacity: 1 });
      } else {
        const tl = gsap.timeline({
          onComplete: () => {
            if (currentContent) gsap.set(currentContent, { display: "none" });
          },
        });

        if (currentContent) {
          tl.to(currentContent, {
            duration: 0.3,
            x: "-100%",
            opacity: 0,
            ease: "power2.out",
          });
        }

        if (targetContent) {
          gsap.set(targetContent, { display: "block", x: "100%", opacity: 0 });
          tl.to(targetContent, {
            duration: 0.3,
            x: "0%",
            opacity: 1,
            ease: "power2.in",
          });
        }
      }

      // Update button styles
      buttons.forEach((btn) => {
        btn.style.background =
          btn.dataset.tab === tab
            ? "color-mix(in oklab, var(--color-accent) 30%, transparent) !important"
            : "var(--color-fore-light) !important";
      });
    }

    function getNextTab(): string {
      const current = parseInt(parent.dataset.contentActive || "1", 10);
      const next = current >= TOTAL_TABS ? 1 : current + 1;
      return next.toString();
    }

    function startAutoplay() {
      if (autoplayTimer || isPaused || !isInView) return;

      autoplayTimer = setTimeout(() => {
        autoplayTimer = null;
        goToTab(getNextTab());
        startAutoplay();
      }, AUTOPLAY_INTERVAL);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearTimeout(autoplayTimer);
        autoplayTimer = null;
      }
    }

    function pauseAutoplay() {
      isPaused = true;
      stopAutoplay();
    }

    function resumeAutoplay() {
      isPaused = false;
      if (isInView) startAutoplay();
    }

    // Intersection Observer for viewport detection
    observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          isInView = entry.isIntersecting;
          if (isInView && !isPaused) {
            startAutoplay();
          } else {
            stopAutoplay();
          }
        });
      },
      { threshold: 0.3 },
    );

    observer.observe(parent);

    // Hover/touch handlers for pause
    const handleInteractionStart = () => pauseAutoplay();
    const handleInteractionEnd = () => {
      // Delay resume slightly to avoid immediate restart
      setTimeout(resumeAutoplay, 500);
    };

    contentContainer?.addEventListener("mouseenter", handleInteractionStart);
    contentContainer?.addEventListener("mouseleave", handleInteractionEnd);
    contentContainer?.addEventListener("touchstart", handleInteractionStart, {
      passive: true,
    });
    contentContainer?.addEventListener("touchend", handleInteractionEnd, {
      passive: true,
    });

    // Button click handlers
    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const tab = button.dataset.tab;
        if (!tab || tab === parent.dataset.contentActive) return;

        // Stop and reset autoplay on manual interaction
        stopAutoplay();
        isPaused = false;
        goToTab(tab);
        // Restart autoplay after manual switch
        if (isInView) startAutoplay();
      });
    });

    // Cleanup on page navigation (Astro View Transitions)
    document.addEventListener(
      "astro:before-swap",
      () => {
        stopAutoplay();
        observer?.disconnect();
        contentContainer?.removeEventListener(
          "mouseenter",
          handleInteractionStart,
        );
        contentContainer?.removeEventListener(
          "mouseleave",
          handleInteractionEnd,
        );
        contentContainer?.removeEventListener(
          "touchstart",
          handleInteractionStart,
        );
        contentContainer?.removeEventListener("touchend", handleInteractionEnd);
      },
      { once: true },
    );
  }

  document.addEventListener("astro:page-load", switchTab);
</script>
